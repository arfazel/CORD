


version: '2'

# XOS docker compose
# generated by cord-profile/templates/docker-compose.yml.j2

networks:
  xos:
    external: true

services:
  elk:
    image: docker-registry:5000/sebp/elk:candidate
    ports:
      - "5601:5601"
      - "9200:9200"
    networks:
      - xos
 
  consul:
    image: docker-registry:5000/gliderlabs/consul-server:candidate
    command: "-advertise=${MYHOST} -server -bootstrap"
    ports:
      - "127.0.0.1:8500:8500"
    networks:
      - xos
    environment:
      SERVICE_8300_IGNORE: "yes"
      SERVICE_8301_IGNORE: "yes"
      SERVICE_8302_IGNORE: "yes"
      SERVICE_8400_IGNORE: "yes"
      SERVICE_8500_NAME: "consul-rest"
      SERVICE_8600_IGNORE: "yes"
    restart: unless-stopped
  registrator:
    image: docker-registry:5000/gliderlabs/registrator:candidate
    command: [
         "-ip=${DOCKER_HOST_IP}",
         "-internal",
         "-retry-attempts", "100",
         "consul://consul:8500"
    ]
    networks:
      - xos
    links:
      - consul
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock
    depends_on:
      - consul
    restart: unless-stopped
  xos_db:
    image: docker-registry:5000/xosproject/xos-postgres:candidate
    networks:
      - xos
    expose:
      - "5432"
    depends_on:
      - registrator
    environment:
      SERVICE_5432_NAME: "xos-db"
    restart: unless-stopped

  xos_redis:
    image: docker-registry:5000/redis:candidate
    networks:
     - xos
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    depends_on:
      - registrator
    environment:
      SERVICE_NAME: "redis"
    restart: unless-stopped

  xos_gui:
    image: docker-registry:5000/xosproject/xos-gui:candidate
    networks:
     - xos
    ports:
      - "4000:4000"
    links:
      - xos_ws:xos-ws
      - xos_chameleon:xos-chameleon
    depends_on:
      - xos_ws
      - xos_chameleon
    volumes:
      - /opt/cord_profile/style.config.js:/var/www/dist/style.config.js
      - /opt/cord_profile/app.config.js:/var/www/dist/app.config.js
    volumes_from:
      - gui_extensions_store
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    depends_on:
      - registrator
    environment:
      SERVICE_4000_NAME: "xos-gui"
      SERVICE_80_IGNORE: "yes"
    restart: unless-stopped

  xos_tosca:
    image: docker-registry:5000/xosproject/xos-tosca:candidate
    networks:
     - xos
    ports:
      - "9102:9102"
    links:
      - xos_core:xos-core
    volumes:
      - /opt/cord_profile/xos-tosca.config.yaml:/opt/xos-tosca/src/xos-tosca.config.yaml
      - /opt/cord_profile/im_cert_chain.pem:/usr/local/share/ca-certificates/local_certs.crt:ro
    depends_on:
      - xos_core
      - registrator
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    environment:
      SERVICE_9102_NAME: "xos-tosca"
    restart: unless-stopped

  xos_chameleon:
    image: docker-registry:5000/xosproject/chameleon:candidate
    networks:
     - xos
    command: python chameleon/chameleon/main.py -R 9101 -G xos-core:50055 --swagger-url /apidocs
    ports:
      - "9101:9101"
    links:
      - xos_core:xos-core
    depends_on:
      - xos_core
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    depends_on:
      - registrator
    environment:
      SERVICE_9101_NAME: "xos-rest"
    restart: unless-stopped

  gui_extensions_store:
    image: docker-registry:5000/node:candidate
    networks:
     - xos
    command: /bin/true
    volumes:
      - /var/www/dist/extensions
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    depends_on:
      - registrator

  xos_ws:
    image: docker-registry:5000/xosproject/xos-ws:candidate
    networks:
     - xos
    command: npm start -- --config gateway-config.yml
    ports:
      - "3000:3000"
    links:
      - xos_core:xos
      - xos_redis:redis
    depends_on:
      - xos_core
      - xos_redis
    volumes:
      - /opt/cord_profile/gateway-config.yml:/var/www/src/config/gateway-config.yml
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    depends_on:
      - registrator
    environment:
      SERVICE_3000_NAME: "xos-ws"
    restart: unless-stopped

  xos_core:
    image: docker-registry:5000/xosproject/xos-ui:candidate
    networks:
     - xos
    command: bash -c "service filebeat start; cd coreapi; bash ./start_coreapi.sh"
    ports:
      - "50051:50051"
      - "50055:50055"
    links:
      - xos_db:xos-db
      - consul:consul
      - xos_redis:redis
    depends_on:
      - xos_db
      - registrator
      - xos_redis
    volumes:
      - /opt/cord_profile/xos_config.yaml:/opt/xos/xos_config.yaml:ro
      - /opt/cord_profile:/opt/cord_profile:ro
      - /opt/cord_profile/im_cert_chain.pem:/usr/local/share/ca-certificates/local_certs.crt:ro
      - /opt/cord_profile/initial_data.yaml:/opt/xos/core/migrations/initial_data.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    environment:
      SERVICE_50051_NAME: "xos-grpc-secure"
      SERVICE_50055_NAME: "xos-grpc-insecure"
    restart: unless-stopped

  gui-extension-vtr:
    image: docker-registry:5000/xosproject/gui-extension-vtr:candidate
    networks:
     - xos
    command: /bin/sh -c "mkdir -p /var/www/dist/extensions/vtr/ && cp -R /tmp/* /var/www/dist/extensions/vtr/"
    volumes_from:
      - gui_extensions_store
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    depends_on:
      - registrator
  gui-extension-rcord:
    image: docker-registry:5000/xosproject/gui-extension-rcord:candidate
    networks:
     - xos
    command: /bin/sh -c "mkdir -p /var/www/dist/extensions/rcord/ && cp -R /tmp/* /var/www/dist/extensions/rcord/"
    volumes_from:
      - gui_extensions_store
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    depends_on:
      - registrator

  rcord-synchronizer:
    image: docker-registry:5000/xosproject/rcord-synchronizer:candidate
    networks:
     - xos
    depends_on:
      - registrator
      - xos_redis
    links:
      - consul:consul
      - xos_core:xos-core
      - xos_redis:redis
    volumes:
      - /opt/cord_profile/xos_config_synchronizer.yaml:/opt/xos/xos_config.yaml:ro
      - /opt/cord_profile/node_key:/opt/cord_profile/node_key:ro
      - /opt/credentials:/opt/xos/services/rcord/credentials:ro
      - /opt/cord_profile/im_cert_chain.pem:/usr/local/share/ca-certificates/local_certs.crt:ro
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    environment:
      SERVICE_NAME: "xos-rcord-synchronizer"
    restart: on-failure

  volt-synchronizer:
    image: docker-registry:5000/xosproject/volt-synchronizer:candidate
    networks:
     - xos
    depends_on:
      - registrator
      - xos_redis
    links:
      - consul:consul
      - xos_core:xos-core
      - xos_redis:redis
    volumes:
      - /opt/cord_profile/xos_config_synchronizer.yaml:/opt/xos/xos_config.yaml:ro
      - /opt/cord_profile/node_key:/opt/cord_profile/node_key:ro
      - /opt/credentials:/opt/xos/services/volt/credentials:ro
      - /opt/cord_profile/im_cert_chain.pem:/usr/local/share/ca-certificates/local_certs.crt:ro
      - /opt/cord_profile/key_import/volt_rsa:/opt/xos/services/volt/keys/volt_rsa:ro
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    environment:
      SERVICE_NAME: "xos-volt-synchronizer"
    restart: on-failure

  vtn-synchronizer:
    image: docker-registry:5000/xosproject/vtn-synchronizer:candidate
    networks:
     - xos
    depends_on:
      - registrator
      - xos_redis
    links:
      - consul:consul
      - xos_core:xos-core
      - xos_redis:redis
    volumes:
      - /opt/cord_profile/xos_config_synchronizer.yaml:/opt/xos/xos_config.yaml:ro
      - /opt/cord_profile/node_key:/opt/cord_profile/node_key:ro
      - /opt/credentials:/opt/xos/services/vtn/credentials:ro
      - /opt/cord_profile/im_cert_chain.pem:/usr/local/share/ca-certificates/local_certs.crt:ro
      - /opt/cord_profile/key_import/vsg_rsa:/opt/xos/services/vtn/keys/vsg_rsa:ro
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    environment:
      SERVICE_NAME: "xos-vtn-synchronizer"
    restart: on-failure

  openstack-synchronizer:
    image: docker-registry:5000/xosproject/openstack-synchronizer:candidate
    networks:
     - xos
    depends_on:
      - registrator
      - xos_redis
    links:
      - consul:consul
      - xos_core:xos-core
      - xos_redis:redis
    volumes:
      - /opt/cord_profile/xos_config_synchronizer.yaml:/opt/xos/xos_config.yaml:ro
      - /opt/cord_profile/node_key:/opt/cord_profile/node_key:ro
      - /opt/credentials:/opt/xos/services/openstack/credentials:ro
      - /opt/cord_profile/im_cert_chain.pem:/usr/local/share/ca-certificates/local_certs.crt:ro
      - /opt/cord_profile/images:/opt/xos/images:ro
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    environment:
      SERVICE_NAME: "xos-openstack-synchronizer"
    restart: on-failure

  onos-synchronizer:
    image: docker-registry:5000/xosproject/onos-synchronizer:candidate
    networks:
     - xos
    depends_on:
      - registrator
      - xos_redis
    links:
      - consul:consul
      - xos_core:xos-core
      - xos_redis:redis
    volumes:
      - /opt/cord_profile/xos_config_synchronizer.yaml:/opt/xos/xos_config.yaml:ro
      - /opt/cord_profile/node_key:/opt/cord_profile/node_key:ro
      - /opt/credentials:/opt/xos/services/onos/credentials:ro
      - /opt/cord_profile/im_cert_chain.pem:/usr/local/share/ca-certificates/local_certs.crt:ro
      - /opt/cord_profile/key_import/onos_rsa:/opt/xos/services/onos/keys/onos_rsa:ro
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    environment:
      SERVICE_NAME: "xos-onos-synchronizer"
    restart: on-failure

  vrouter-synchronizer:
    image: docker-registry:5000/xosproject/vrouter-synchronizer:candidate
    networks:
     - xos
    depends_on:
      - registrator
      - xos_redis
    links:
      - consul:consul
      - xos_core:xos-core
      - xos_redis:redis
    volumes:
      - /opt/cord_profile/xos_config_synchronizer.yaml:/opt/xos/xos_config.yaml:ro
      - /opt/cord_profile/node_key:/opt/cord_profile/node_key:ro
      - /opt/credentials:/opt/xos/services/vrouter/credentials:ro
      - /opt/cord_profile/im_cert_chain.pem:/usr/local/share/ca-certificates/local_certs.crt:ro
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    environment:
      SERVICE_NAME: "xos-vrouter-synchronizer"
    restart: on-failure

  addressmanager-synchronizer:
    image: docker-registry:5000/xosproject/addressmanager-synchronizer:candidate
    networks:
     - xos
    depends_on:
      - registrator
      - xos_redis
    links:
      - consul:consul
      - xos_core:xos-core
      - xos_redis:redis
    volumes:
      - /opt/cord_profile/xos_config_synchronizer.yaml:/opt/xos/xos_config.yaml:ro
      - /opt/cord_profile/node_key:/opt/cord_profile/node_key:ro
      - /opt/credentials:/opt/xos/services/addressmanager/credentials:ro
      - /opt/cord_profile/im_cert_chain.pem:/usr/local/share/ca-certificates/local_certs.crt:ro
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    environment:
      SERVICE_NAME: "xos-addressmanager-synchronizer"
    restart: on-failure

  vsg-synchronizer:
    image: docker-registry:5000/xosproject/vsg-synchronizer:candidate
    networks:
     - xos
    depends_on:
      - registrator
      - xos_redis
    links:
      - consul:consul
      - xos_core:xos-core
      - xos_redis:redis
    volumes:
      - /opt/cord_profile/xos_config_synchronizer.yaml:/opt/xos/xos_config.yaml:ro
      - /opt/cord_profile/node_key:/opt/cord_profile/node_key:ro
      - /opt/credentials:/opt/xos/services/vsg/credentials:ro
      - /opt/cord_profile/im_cert_chain.pem:/usr/local/share/ca-certificates/local_certs.crt:ro
      - /opt/cord_profile/key_import/vsg_rsa:/opt/xos/services/vsg/keys/vsg_rsa:ro
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    environment:
      SERVICE_NAME: "xos-vsg-synchronizer"
    restart: on-failure

  vtr-synchronizer:
    image: docker-registry:5000/xosproject/vtr-synchronizer:candidate
    networks:
     - xos
    depends_on:
      - registrator
      - xos_redis
    links:
      - consul:consul
      - xos_core:xos-core
      - xos_redis:redis
    volumes:
      - /opt/cord_profile/xos_config_synchronizer.yaml:/opt/xos/xos_config.yaml:ro
      - /opt/cord_profile/node_key:/opt/cord_profile/node_key:ro
      - /opt/credentials:/opt/xos/services/vtr/credentials:ro
      - /opt/cord_profile/im_cert_chain.pem:/usr/local/share/ca-certificates/local_certs.crt:ro
      - /opt/cord_profile/key_import/vsg_rsa:/opt/xos/services/vtr/keys/vsg_rsa:ro
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    environment:
      SERVICE_NAME: "xos-vtr-synchronizer"
    restart: on-failure

  fabric-synchronizer:
    image: docker-registry:5000/xosproject/fabric-synchronizer:candidate
    networks:
     - xos
    depends_on:
      - registrator
      - xos_redis
    links:
      - consul:consul
      - xos_core:xos-core
      - xos_redis:redis
    volumes:
      - /opt/cord_profile/xos_config_synchronizer.yaml:/opt/xos/xos_config.yaml:ro
      - /opt/cord_profile/node_key:/opt/cord_profile/node_key:ro
      - /opt/credentials:/opt/xos/services/fabric/credentials:ro
      - /opt/cord_profile/im_cert_chain.pem:/usr/local/share/ca-certificates/local_certs.crt:ro
    logging:
      driver: "json-file"
      options:
        max-size: "1000k"
        max-file: "5"
    environment:
      SERVICE_NAME: "xos-fabric-synchronizer"
    restart: on-failure

